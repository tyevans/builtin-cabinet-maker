# Refinement Tracking: FRD-04 Variable Section Widths & Types

## Analysis Progress
- [x] Initial codebase scan
- [x] Backend support analysis (domain entities, value objects, services)
- [x] Application layer analysis (config schema, DTOs, adapters, validator)
- [x] Infrastructure layer analysis (STL exporter, formatters)
- [x] FRD-02/FRD-03 dependency analysis
- [x] Testing patterns analysis
- [x] Final consolidation and FRD update

## Current Focus
All analysis complete. Updating FRD with implementation pathways.

---

## Key Discovery: Core Functionality Already Implemented

**Critical Finding:** Unlike what the FRD assumes, the core variable section width functionality is ALREADY IMPLEMENTED in the codebase. The FRD proposes features that largely exist.

### Already Implemented (DONE)

1. **SectionSpec with fill support** - `section_resolver.py`:
   - `SectionSpec` dataclass with `width: float | Literal["fill"]`
   - `shelves: int` field
   - `wall: str | int | None` field for wall assignment
   - `is_fill` and `fixed_width` properties
   - Full validation in `__post_init__`

2. **Width resolution algorithm** - `resolve_section_widths()`:
   - Calculates available interior width
   - Subtracts divider thicknesses
   - Distributes remaining width equally among fill sections
   - Comprehensive validation for edge cases
   - 360+ lines of thoroughly tested code

3. **LayoutCalculator.generate_cabinet_from_specs()** - `services.py`:
   - Takes `section_specs: list[SectionSpec]`
   - Calls `resolve_section_widths()`
   - Creates `Section` entities with correct widths
   - Generates evenly-spaced shelves per section

4. **Divider generation** - `Cabinet.get_all_panels()`:
   - Already generates `PanelType.DIVIDER` between sections
   - Correct positioning: `section.position.x + section.width`
   - Uses `interior_depth` and `interior_height`

5. **Config schema SectionConfig** - `schema.py`:
   - `width: float | Literal["fill"] = "fill"`
   - `shelves: int` with ge=0, le=20 validation
   - `wall: str | int | None` for wall assignment

6. **Config adapter** - `adapter.py`:
   - `config_to_section_specs()` converts config to domain objects
   - `has_section_specs()` to detect when specs are specified

7. **Room and RoomLayoutService** - `services.py`:
   - `RoomLayoutService` with section-to-wall assignment
   - `assign_sections_to_walls()` handles wall references
   - `validate_fit()` checks sections fit on walls
   - `compute_section_transforms()` for 3D positioning

8. **Comprehensive tests** - `test_section_resolver.py`:
   - 365 lines of tests
   - All fill sections, mixed widths, all fixed
   - Edge cases and error conditions

### Not Implemented (FRD-04 Novel Requirements)

1. **SectionType enum** - `open`, `doored`, `drawers`, `cubby`
   - No section type concept exists yet
   - Section entity has no `section_type` field

2. **Section-level depth override**
   - `SectionSpec` has no `depth` field
   - All sections inherit cabinet depth

3. **min_width / max_width constraints on sections**
   - No min/max constraint fields
   - No constraint validation in width calculation

4. **default_shelves on Cabinet**
   - No `default_shelf_count` field
   - Each section must specify its own shelf count

5. **ResolvedWidth and WidthCalculationResult value objects**
   - `resolve_section_widths()` returns `list[float]`
   - No metadata about which sections were fill vs fixed

---

## Findings Summary

### Backend Support (Domain Layer)

**Relevant Files:**
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/domain/section_resolver.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/domain/entities.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/domain/value_objects.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/domain/services.py`

**Current State:**

1. **SectionSpec** (section_resolver.py:19-55) - COMPLETE
   - `width: float | Literal["fill"]` - implemented
   - `shelves: int = 0` - implemented
   - `wall: str | int | None = None` - implemented
   - `is_fill` property - implemented
   - `fixed_width` property - implemented
   - Missing: `section_type`, `depth`, `min_width`, `max_width`

2. **resolve_section_widths()** (section_resolver.py:57-179) - COMPLETE
   - Calculates interior width minus outer panels
   - Subtracts divider thicknesses
   - Distributes remaining to fill sections
   - Full validation and error handling
   - Missing: min/max constraint checking

3. **Section entity** (entities.py:61-73) - PARTIAL
   - Has `width`, `height`, `depth`, `position`, `shelves`
   - Missing: `section_type` field

4. **Cabinet entity** (entities.py:76-215) - COMPLETE for current needs
   - Has `sections: list[Section]`
   - `get_all_panels()` generates dividers between sections
   - Missing: `default_shelf_count` field

5. **LayoutCalculator** (services.py:41-174) - COMPLETE
   - `generate_cabinet_from_specs()` uses section_specs
   - Missing: section depth override handling

6. **RoomLayoutService** (services.py:364-744) - COMPLETE
   - Section-to-wall assignment
   - Wall reference resolution (index and name)
   - Fit validation

### Application Layer

**Current State:**

1. **SectionConfig** (schema.py:90-112) - PARTIAL
   - `width: float | Literal["fill"] = "fill"` - implemented
   - `shelves: int` with constraints - implemented
   - `wall: str | int | None` - implemented
   - Missing: `section_type`, `depth`, `min_width`, `max_width`

2. **CabinetConfig** (schema.py:114-143)
   - Missing: `default_shelves` field

3. **Config adapter** (adapter.py:112-157) - PARTIAL
   - `config_to_section_specs()` - implemented
   - Needs update to handle new fields

---

## Lateral Moves Identified

### 1. Add SectionType enum
**Description:** Add `SectionType` enum to domain layer (value_objects.py or entities.py)
**Rationale:** Required for section type system (FR-03)
**Impact:** Additive - new type, no existing code changes
**Status:** Ready to implement
**Risk:** Low

### 2. Extend SectionSpec with new fields
**Description:** Add `section_type`, `depth`, `min_width`, `max_width` to `SectionSpec`
**Rationale:** Required for FR-04 (constraints) and FR-06 (overrides)
**Impact:** Additive - all new fields have defaults
**Status:** Ready to implement
**Risk:** Low - existing tests pass (fields are optional)

### 3. Extend resolve_section_widths() with constraint checking
**Description:** Add min/max validation after fill width calculation
**Rationale:** Required for FR-04 (constraints)
**Impact:** Behavior change - will reject previously valid configs if constraints violated
**Status:** Requires design decision
**Risk:** Low-Medium - need to ensure backward compatibility

### 4. Add ResolvedWidth value object (OPTIONAL)
**Description:** Replace `list[float]` return with richer result type
**Rationale:** FRD proposes this but it may be over-engineering
**Question:** Is the extra metadata actually needed by callers?
**Status:** Pending decision - may be deferred

### 5. Extend Section entity with section_type
**Description:** Add `section_type: SectionType` field to `Section` entity
**Rationale:** Required for type-based behavior (FR-03)
**Impact:** Additive - default value means existing code works
**Status:** Ready to implement
**Risk:** Low

### 6. Extend SectionConfig in schema
**Description:** Add `section_type`, `depth`, `min_width`, `max_width` to Pydantic model
**Rationale:** Required for config file support
**Impact:** Additive - all optional with defaults
**Status:** Ready to implement
**Risk:** Low

---

## FRD-02/FRD-03 Dependencies

### FRD-02 (Room & Wall Geometry)
**Status:** Already implemented in codebase
- `WallSegment` entity - done
- `Room` aggregate - done
- `RoomLayoutService` - done
- Config schema with room support - done

FRD-04's wall reference feature (`sections[].wall`) is ALREADY SUPPORTED.

### FRD-03 (Obstacle Avoidance)
**Status:** "Codebase Aligned and Ready for Task Breakdown" but not implemented
**Impact on FRD-04:**
- FRD-03 proposes `height_mode` on sections - this is NOT part of FRD-04
- Fill calculation in FRD-04 happens BEFORE obstacle avoidance
- FRD-03 would adjust section positions/sizes after width resolution

**Conclusion:** FRD-04 can proceed independently. The width calculation is upstream of obstacle avoidance.

---

## Revised FRD-04 Scope Assessment

The FRD significantly overestimates the work needed because core functionality exists.

### Already Done (Remove from FRD)
- FR-01.1, FR-01.2, FR-01.3, FR-01.4 (width specification) - DONE
- FR-02 (fill width calculation) - DONE (except constraint checking)
- FR-05 (vertical dividers) - DONE
- FR-06.1 (shelf count override) - PARTIALLY DONE (per-section, not cabinet default)
- Schema 1.2 sections[].width - DONE
- Schema 1.2 sections[].shelves - DONE
- Schema 1.2 sections[].wall - DONE

### Remaining Work
1. Add `SectionType` enum (FR-03)
2. Add `section_type` field to `SectionSpec` and `Section` entities
3. Add `section_type` to `SectionConfig` schema
4. Add `min_width` / `max_width` to `SectionSpec` (FR-04)
5. Implement constraint validation in `resolve_section_widths()` (FR-04.3)
6. Add `depth` override to `SectionSpec` (FR-06.2)
7. Implement depth override in `generate_cabinet_from_specs()` (FR-06.3)
8. Add `default_shelves` to `CabinetConfig` (FR-06.1)
9. Update config adapter for new fields
10. Add tests for new features
11. Update schema documentation

---

## Infrastructure Layer Analysis

**Relevant Files:**
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/infrastructure/exporters.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/infrastructure/stl_exporter.py`

**Current State:**

1. **LayoutDiagramFormatter** (exporters.py:41-123)
   - ASCII art shows cabinet sections with dividers
   - Displays section count, total shelves
   - No awareness of section types (not needed - types don't affect visual structure)

2. **JsonExporter** (exporters.py:155-190)
   - Exports cabinet structure with sections
   - Could be enhanced to include section types if needed
   - Not critical for FRD-04 core functionality

3. **CutListFormatter** (exporters.py:11-38)
   - No changes needed - section types don't affect cut list structure

4. **StlExporter** (stl_exporter.py)
   - Uses Panel3DMapper which already handles sections
   - No changes needed for FRD-04

**Needed Work:**
- [ ] (Optional) Extend JsonExporter to include section type in output - Complexity: Low
- [ ] (Optional) Extend LayoutDiagramFormatter to show section types visually - Complexity: Low

---

## Testing Patterns Analysis

**Relevant Files:**
- `/home/ty/workspace/builtin-cabinets-and-shelves/tests/unit/test_section_resolver.py` - 365 lines
- `/home/ty/workspace/builtin-cabinets-and-shelves/tests/unit/test_entities.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/tests/unit/test_config_schema.py`

**Existing Patterns:**

1. **Test organization:** Class-based with descriptive names (`TestSectionSpec`, `TestResolveSectionWidthsAllFill`)
2. **Assertions:** Uses `pytest.approx()` for floating-point comparisons
3. **Error testing:** Uses `pytest.raises(ExceptionType, match="pattern")`
4. **Test coverage:** Comprehensive edge cases and error conditions

**Tests Already Existing:**
- `test_section_resolver.py` has 365 lines covering:
  - `SectionSpec` creation and validation
  - All fill sections scenarios
  - Mixed fixed/fill scenarios
  - All fixed sections scenarios
  - Error conditions
  - Edge cases

**Tests Needed for FRD-04:**
- [ ] Test `SectionType` enum values
- [ ] Test `SectionSpec` with `section_type` field
- [ ] Test `SectionSpec` with `depth` override field
- [ ] Test `SectionSpec` with `min_width`/`max_width` constraints
- [ ] Test `resolve_section_widths()` with constraint validation
- [ ] Test `Section` entity with `section_type` field
- [ ] Test `SectionConfig` schema with new fields
- [ ] Test config adapter for new field conversion
- [ ] Integration tests for section type in cabinet generation

---

## Complexity Assessment (Revised)

Based on analysis, the actual work is MUCH SMALLER than the FRD estimates:

| Component | Complexity | Effort | Risk | Notes |
|-----------|------------|--------|------|-------|
| `SectionType` enum | Low | 0.25 day | Low | Simple enum, 4 values |
| Extend `SectionSpec` (4 new fields) | Low | 0.25 day | Low | All optional with defaults |
| Extend `resolve_section_widths()` constraints | Medium | 0.5 day | Low | Add min/max validation |
| Extend `Section` entity | Low | 0.1 day | Low | Add one field |
| Extend `Cabinet` with `default_shelf_count` | Low | 0.1 day | Low | Add one field |
| Update `generate_cabinet_from_specs()` | Low | 0.25 day | Low | Handle depth override |
| Extend `SectionConfig` schema | Low | 0.25 day | Low | Pydantic fields |
| Update config adapter | Low | 0.25 day | Low | Map new fields |
| Update validator (optional) | Low | 0.25 day | Low | Add min/max validation |
| Unit tests | Medium | 0.5 day | Low | Test new fields |
| Integration tests | Low | 0.25 day | Low | Already have patterns |
| **Total** | | **2.5-3 days** | | Much less than original 7+ days |

---

## Implementation Status Summary

### DONE (Already Implemented)
1. `width: float | Literal["fill"]` specification
2. Fill width calculation algorithm
3. Divider generation between sections
4. Wall assignment for sections
5. Config schema for width/shelves/wall
6. Config adapter for section specs
7. Comprehensive tests for width resolution
8. RoomLayoutService integration

### TO DO (FRD-04 Remaining Work)
1. Add `SectionType` enum
2. Add `section_type` to `SectionSpec`, `Section`, `SectionConfig`
3. Add `depth` override to `SectionSpec`, `SectionConfig`
4. Add `min_width`/`max_width` to `SectionSpec`, `SectionConfig`
5. Implement constraint validation in `resolve_section_widths()`
6. Add `default_shelves` to `CabinetConfig`
7. Update `generate_cabinet_from_specs()` for depth override
8. Update config adapter for new fields
9. Add tests for new features

---

## Open Questions Resolved

1. **FRD-02 Dependency:** Room and wall geometry is ALREADY IMPLEMENTED. No waiting required.

2. **FRD-03 Dependency:** Fill calculation happens BEFORE obstacle avoidance. These are independent. FRD-04 can proceed without waiting for FRD-03.

3. **ResolvedWidth value object:** The FRD proposes returning metadata about which sections were fill vs fixed. This is optional and can be deferred - current callers don't need this information.

---

## Next Steps

1. Update FRD with implementation pathways marking what's done vs remaining
2. Mark FRD as "Codebase Aligned and Ready for Task Breakdown"
