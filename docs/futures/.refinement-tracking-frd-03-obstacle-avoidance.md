# Refinement Tracking: FRD-03 Obstacle Definition & Avoidance

## Analysis Progress
- [x] Initial codebase scan
- [x] Backend support analysis (domain entities, value objects, services)
- [x] Application layer analysis (config schema, DTOs, adapters, validator)
- [x] Infrastructure layer analysis (STL exporter, formatters)
- [x] FRD-02 dependency analysis (walls, room geometry in progress)
- [x] Testing patterns analysis
- [x] Final consolidation and FRD update

## Current Focus
Consolidating findings and updating FRD with implementation pathways.

---

## Findings Summary

### Domain Layer (Backend Support)

**Relevant Files:**
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/domain/entities.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/domain/value_objects.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/domain/services.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/domain/section_resolver.py`

**Current State:**

1. **Wall Entity** (entities.py:213-228):
   - Simple frozen dataclass with `width`, `height`, `depth`
   - No concept of obstacles or wall segments
   - **Gap:** No `wall_index` reference for obstacle placement
   - **FRD-02 Dependency:** `WallSegment` entity (in progress) will provide wall indexing

2. **Position/Position3D Value Objects** (value_objects.py:51-118):
   - `Position(x, y)` for cabinet-internal 2D coordinates (non-negative constraint)
   - `Position3D(x, y, z)` for 3D space (non-negative constraint)
   - **Gap:** These are for cabinet placement, not obstacle zone bounds
   - FRD proposes `SectionBounds` and `ObstacleZone` - different semantic purpose

3. **BoundingBox3D** (value_objects.py:121-173):
   - Used for STL mesh generation with `get_vertices()` and `get_triangles()`
   - Has `origin: Position3D` and size dimensions
   - **Key Gap:** No 2D bounding box for obstacle collision detection
   - FRD's `ObstacleZone` and `SectionBounds` operate in 2D on wall surface

4. **Section Entity** (entities.py:56-69):
   - Has `width`, `height`, `depth`, `position`, and `shelves`
   - No `height_mode` for partial-height sections
   - **Gap:** No support for upper/lower cabinet sections around windows

5. **SectionSpec** (section_resolver.py:19-50):
   - Already supports `width: float | Literal["fill"]` and `shelves: int`
   - **Gap:** No `height_mode` or `wall` assignment field
   - **FRD-02 Dependency:** `wall` field will be added in FRD-02

6. **LayoutCalculator** (services.py:38-171):
   - Has `generate_cabinet()` and `generate_cabinet_from_specs()`
   - Assumes full-height sections across entire wall
   - **Key Gap:** No obstacle awareness or section splitting logic
   - This is where `ObstacleAwareLayoutService` would integrate

### Application Layer

**Relevant Files:**
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/application/config/schema.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/application/config/adapter.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/application/config/validator.py`

**Current State:**

1. **Configuration Schema** (schema.py):
   - Schema version 1.x supported (pattern: `r"^\d+\.\d+$"`)
   - `CabinetConfiguration` is root model with `schema_version`, `cabinet`, `output`
   - `SectionConfig` has `width` and `shelves` fields
   - Uses Pydantic v2 with `extra="forbid"` (strict validation)
   - **Gap:** No `room` object (FRD-02), no `obstacles` array, no `obstacle_defaults`
   - **Gap:** No `height_mode` field on sections

2. **Config Adapter** (adapter.py):
   - `config_to_dtos()` converts config to `WallInput` and `LayoutParametersInput`
   - `config_to_section_specs()` converts sections to domain `SectionSpec` objects
   - **Gap:** No `config_to_obstacles()` function
   - **Gap:** No clearance defaults handling

3. **Config Validator** (validator.py):
   - Has `ValidationResult`, `ValidationError`, `ValidationWarning` structures
   - Has `check_woodworking_advisories()` for shelf span, material thickness, aspect ratio
   - **Extension Point:** Add obstacle validation rules (V-01 through V-06)
   - **Key Patterns:** Uses path-based error messages (e.g., "cabinet.sections[0].width")

### Infrastructure Layer

**Relevant Files:**
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/infrastructure/stl_exporter.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/infrastructure/exporters.py`

**Current State:**

1. **STL Exporter** (stl_exporter.py):
   - `StlMeshBuilder` creates STL meshes from `BoundingBox3D`
   - `StlExporter.export()` uses `Panel3DMapper` to get boxes
   - **Gap:** No awareness of obstacles (not needed - cabinets avoid obstacles, not show them)
   - STL export is downstream of layout - obstacle avoidance happens in layout service

2. **Layout Diagram Formatter** (exporters.py:41-123):
   - ASCII art shows single cabinet layout with sections and shelves
   - **Future Enhancement:** Could show obstacle zones on wall diagram
   - **Gap:** No visualization of obstacles or partial-height sections

3. **JSON Exporter** (exporters.py:155-189):
   - Exports cabinet, cut list, and material estimate
   - **Future Enhancement:** Could include obstacle data in output

### Testing Patterns

**Relevant Files:**
- `/home/ty/workspace/builtin-cabinets-and-shelves/tests/unit/test_config_schema.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/tests/fixtures/configs/`

**Current Patterns:**

1. Uses pytest with clear test class organization
2. Pydantic validation tested via direct model instantiation and `pytest.raises`
3. Config loading tested with JSON fixture files in `tests/fixtures/configs/`
4. `ValidationResult` tested for error/warning handling
5. Tests use `FIXTURES_PATH` relative to test file location

---

## FRD-02 Dependencies (Critical)

FRD-03 depends heavily on FRD-02 (Room & Wall Geometry) which is currently in implementation:

### Already Planned in FRD-02 (That FRD-03 Depends On):
1. **WallSegment Entity** - Provides `wall_index` for obstacle placement
2. **Room Aggregate** - Contains ordered wall segments
3. **RoomLayoutService** - Section-to-wall assignment infrastructure
4. **Config Schema v1.1** - `room` object with `walls` array
5. **SectionConfig.wall** field - Wall assignment per section

### FRD-03 Extensions to FRD-02 Foundation:
1. **Schema v1.2** - Add `obstacles` array to room, add `obstacle_defaults` to root
2. **SectionConfig.height_mode** - Add `full`, `lower`, `upper`, `auto` modes
3. **Obstacle integration** - Obstacles reference walls by index

### Implementation Order Implication:
- FRD-02 MUST complete Phase 1-2 (WallSegment, Room, RoomLayoutService) before FRD-03 can begin
- FRD-03 Phase 1 (Obstacle Entity) can start in parallel with FRD-02 Phase 3-4
- FRD-03 Phase 3 (Layout Integration) requires FRD-02's RoomLayoutService

---

## Lateral Moves Identified

### 1. SectionSpec Extension for height_mode
**Description:** Extend `SectionSpec` in `section_resolver.py` with optional `height_mode` field.
**Rationale:** Required for partial-height sections (upper/lower around windows).
**Impact:** Additive change to existing dataclass.
**Status:** Ready to implement.
**Risk:** Low - purely additive.

### 2. 2D Bounding Box Value Objects
**Description:** Add `SectionBounds` and `ObstacleZone` to `value_objects.py`.
**Rationale:** Needed for 2D collision detection on wall surfaces.
**Note:** Separate from existing `BoundingBox3D` which is for 3D STL generation.
**Status:** Ready to implement.
**Risk:** Low - new types, no changes to existing code.

### 3. Clearance as Frozen Dataclass
**Description:** Add `Clearance` value object with `top`, `bottom`, `left`, `right` fields.
**Rationale:** Encapsulates clearance distances for type safety and validation.
**Status:** Ready to implement.
**Risk:** Low - new type.

### 4. ObstacleType Enum
**Description:** Add `ObstacleType` enum to `value_objects.py` or `entities.py`.
**Rationale:** Type-safe obstacle categorization with default clearance lookup.
**Status:** Ready to implement.
**Risk:** Low - new type.

### 5. Validation Pattern Extension
**Description:** Extend `validator.py` with obstacle validation functions.
**Pattern:** Follow existing `check_woodworking_advisories()` pattern.
**Status:** Ready to implement after schema changes.
**Risk:** Low - follows existing pattern.

### 6. RoomLayoutService to ObstacleAwareLayoutService
**Description:** Either extend `RoomLayoutService` (from FRD-02) or create wrapper service.
**Options:**
  a) Add obstacle awareness directly to `RoomLayoutService`
  b) Create `ObstacleAwareLayoutService` that wraps `RoomLayoutService`
**Recommendation:** Option (b) - cleaner separation of concerns, testable in isolation.
**Status:** Pending FRD-02 implementation.
**Risk:** Medium - requires FRD-02 foundation.

---

## Integration Points

### 1. Configuration Loading Path
```
JSON File -> load_config() -> CabinetConfiguration (with room.obstacles)
          -> config_to_obstacles() [NEW] -> list[Obstacle]
          -> config_to_clearance_defaults() [NEW] -> dict[ObstacleType, Clearance]
```

### 2. Layout Generation Path
```
Room + Obstacles + SectionSpecs -> ObstacleAwareLayoutService [NEW]
                                -> ObstacleCollisionService.get_obstacle_zones()
                                -> For each wall: find_valid_regions()
                                -> Section splitting/resizing logic
                                -> PlacedSection with SectionBounds
                                -> Existing LayoutCalculator for cabinet generation
```

### 3. Validation Path
```
CabinetConfiguration -> validate_obstacles() [NEW]
                     -> check_obstacle_bounds()
                     -> check_wall_references()
                     -> check_blocked_areas()
                     -> merge with existing validate_config()
```

### 4. Backward Compatibility Path
```
Config without 'room.obstacles' -> Empty obstacle list
                                -> Existing layout flow unchanged
```

---

## Complexity Assessment

| Component | Complexity | Effort | Risk | Notes |
|-----------|------------|--------|------|-------|
| ObstacleType enum, Clearance VO | Low | 0.5 day | Low | Simple enums/dataclasses |
| Obstacle entity | Low | 0.5 day | Low | Dataclass with zone calculation |
| SectionBounds, ObstacleZone VOs | Low | 0.5 day | Low | 2D bounding rectangles |
| CollisionResult, ValidRegion VOs | Low | 0.25 day | Low | Simple containers |
| ObstacleCollisionService | Medium | 1.5 days | Medium | Zone overlap detection, region finding |
| ObstacleAwareLayoutService | High | 2-3 days | Medium-High | Section splitting, partial-height logic |
| Config schema v1.2 (obstacles) | Low | 0.5 day | Low | Pydantic models |
| Config adapter (obstacles) | Low | 0.5 day | Low | Conversion functions |
| Obstacle validation rules | Medium | 1 day | Low | V-01 through V-06 |
| SectionSpec height_mode | Low | 0.25 day | Low | Add field to existing class |
| Unit tests (obstacles) | Medium | 1.5 days | Low | Collision, layout, config |
| Integration tests | Medium | 1 day | Low | End-to-end obstacle avoidance |
| **Total** | | **9-11 days** | | After FRD-02 foundation |

---

## Dependencies Summary

### Hard Dependencies (Must Complete First)
1. **FRD-02 Phase 1-2**: WallSegment, Room, basic position calculation
2. **FRD-02 Phase 3**: Config schema v1.1 with `room` object

### Soft Dependencies (Can Parallelize)
1. **FRD-02 Phase 4**: Testing/polish can run parallel with FRD-03 Phase 1
2. **FRD-03 Phase 1**: Obstacle entities can start when FRD-02 Phase 1 nears completion

### FRD-03 Cannot Start Until:
- `WallSegment` entity exists (for `wall_index` reference)
- `Room` aggregate exists (for obstacle container)
- Config schema supports `room.walls` (for obstacle context)

---

## Open Questions for User/Team Lead

1. **FRD-02 Progress**: What is the current state of FRD-02 implementation? Are WallSegment and Room entities available?

2. **Schema Versioning**: FRD proposes v1.2 for obstacles. Confirm this versioning strategy (v1.1 for room, v1.2 for obstacles).

3. **Collision Detection Algorithm**: For complex scenarios (multiple overlapping obstacles), should we use simple rectangle intersection or more sophisticated interval tree?

4. **Partial-Height Section Behavior**: When a window blocks the middle of a wall, should `height_mode=auto` prefer:
   a) Lower section only (most common use case)
   b) Both upper and lower sections
   c) Largest available region

5. **Minimum Section Dimensions**: The FRD specifies 6" minimum width. Should there also be a minimum height for partial-height sections?

---

## Next Steps

1. Confirm FRD-02 implementation progress
2. Update FRD-03 with implementation pathways for each concern
3. Mark FRD as "Codebase Aligned and Ready for Task Breakdown" after addressing dependencies
