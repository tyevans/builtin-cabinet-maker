# Refinement Tracking: FRD-02 Room & Wall Geometry Model

## Analysis Progress
- [x] Initial codebase scan
- [x] Backend support analysis (domain entities, value objects, services)
- [x] Application layer analysis (config schema, DTOs, commands, adapters)
- [x] Infrastructure layer analysis (exporters, STL generation)
- [x] Integration points analysis
- [x] Testing patterns analysis
- [ ] Final consolidation and FRD update

## Current Focus
Consolidating findings and updating FRD with implementation pathways.

---

## Findings Summary

### Domain Layer (Backend Support)

**Relevant Files:**
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/domain/entities.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/domain/value_objects.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/domain/services.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/domain/section_resolver.py`

**Current State:**

1. **Existing `Wall` Entity** (entities.py:213-227):
   - Simple dataclass with `width`, `height`, `depth` as frozen value object
   - Has `to_dimensions()` method returning `Dimensions` value object
   - Used by `LayoutCalculator.generate_cabinet()` as input
   - **FRD Migration Path Alignment:** FRD proposes renaming to `WallConstraints` for backward compatibility

2. **Existing Value Objects** (value_objects.py):
   - `Position` (2D x,y) - Used for cabinet-internal positioning
   - `Position3D` (x,y,z) - Used for 3D positioning
   - `Dimensions` (width, height, depth) - Generic dimension container
   - `BoundingBox3D` - Used for STL mesh generation
   - **FRD Alignment:** FRD proposes adding `Point2D` and `WallPosition` - partially overlaps with existing `Position` but serves different purpose (room coordinates vs cabinet-internal coordinates)

3. **`Panel3DMapper` Service** (services.py:252-359):
   - Maps 2D panels to 3D bounding boxes for STL export
   - Assumes single cabinet at origin with fixed orientation
   - **Key Gap:** Does not support rotation or translation for multi-wall scenarios
   - FRD `SectionTransform` will need to integrate with this

4. **`LayoutCalculator` Service** (services.py:38-171):
   - Takes `Wall` and `LayoutParameters` to generate `Cabinet`
   - Has `generate_cabinet_from_specs()` for per-section control
   - **Key Gap:** No concept of room, wall segments, or 3D transforms
   - FRD `RoomLayoutService` will wrap/extend this functionality

5. **`SectionSpec` and `SectionResolver`** (section_resolver.py):
   - Already supports per-section widths (fixed or "fill")
   - Could be extended for wall assignment (`wall_index` or `wall_name`)

### Application Layer

**Relevant Files:**
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/application/config/schema.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/application/config/adapter.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/application/dtos.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/application/commands.py`

**Current State:**

1. **Configuration Schema** (schema.py):
   - Current version: "1.0"
   - Uses Pydantic v2 with `extra="forbid"` (strict validation)
   - `CabinetConfiguration` is root model with `schema_version`, `cabinet`, `output`
   - `SectionConfig` already has `width` (float | Literal["fill"]) and `shelves`
   - **Key Gap:** No `room` object, no `wall` field on sections
   - FRD proposes v1.1 with optional `room` at root level

2. **Config Adapter** (adapter.py):
   - Converts `CabinetConfiguration` to DTOs (`WallInput`, `LayoutParametersInput`)
   - Already has `config_to_section_specs()` for domain-level SectionSpec
   - **Extension Point:** Add `config_to_room()` for room geometry

3. **DTOs** (dtos.py):
   - `WallInput` - simple width/height/depth container (matches existing Wall entity)
   - `LayoutParametersInput` - sections, shelves, materials
   - `LayoutOutput` - cabinet, cut list, material estimates
   - **Key Gap:** No room/wall segment concepts in DTOs

4. **Commands** (commands.py):
   - `GenerateLayoutCommand` orchestrates layout generation
   - Takes optional `section_specs` for per-section control
   - **Extension Point:** Add room geometry to command execution

### Infrastructure Layer

**Relevant Files:**
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/infrastructure/stl_exporter.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/infrastructure/exporters.py`

**Current State:**

1. **STL Exporter** (stl_exporter.py):
   - `StlMeshBuilder` - creates STL meshes from `BoundingBox3D`
   - `StlExporter.export()` - uses `Panel3DMapper` to get boxes, builds combined mesh
   - **Key Gap:** No support for transforming meshes (rotation/translation)
   - FRD requirement: Multi-wall STL with correct 3D positioning

2. **Formatters** (exporters.py):
   - `CutListFormatter`, `LayoutDiagramFormatter`, `MaterialReportFormatter`, `JsonExporter`
   - **Key Gap:** ASCII diagram only shows single cabinet, would need update for multi-wall

### CLI Layer

**Relevant File:**
- `/home/ty/workspace/builtin-cabinets-and-shelves/src/cabinets/cli/main.py`

**Current State:**
- Uses Typer with config file support
- Has `--config` option that loads JSON, merges with CLI overrides
- Calls `GenerateLayoutCommand` for generation
- **Extension Point:** Will need to handle room configs transparently

### Testing Patterns

**Relevant Files:**
- `/home/ty/workspace/builtin-cabinets-and-shelves/tests/unit/test_config_schema.py`
- `/home/ty/workspace/builtin-cabinets-and-shelves/tests/fixtures/configs/` (fixture directory)

**Patterns Identified:**
- Pydantic validation tested via direct model instantiation
- Config loading tested with JSON fixtures
- Uses pytest with clear arrange-act-assert structure
- Fixture configs in `tests/fixtures/configs/`

---

## Lateral Moves Identified

### 1. Wall Entity Deprecation Strategy
**Description:** The FRD proposes renaming `Wall` to `WallConstraints` for backward compatibility.
**Rationale:** Allow gradual migration without breaking existing code.
**Status:** Documented in FRD, straightforward implementation.
**Risk:** Low - additive change

### 2. Position vs Point2D Naming
**Description:** FRD proposes `Point2D` but codebase already has `Position` (2D) and `Position3D`.
**Recommendation:** Use `Point2D` in room/wall context to differentiate from cabinet-internal `Position`.
**Rationale:** Room coordinates are conceptually different from cabinet-internal positioning.
**Status:** Design decision - proceed as FRD specifies.
**Risk:** Low - new types, no breaking changes

### 3. Panel3DMapper Extension for Transforms
**Description:** Current `Panel3DMapper` assumes origin-based cabinet. For multi-wall, panels need rotation/translation.
**Options:**
  a) Extend `Panel3DMapper` to accept transform parameters
  b) Apply transforms at STL mesh level after mapping
  c) Create new `RoomPanel3DMapper` that wraps `Panel3DMapper`
**Recommendation:** Option (c) - Create `RoomPanel3DMapper` that applies `SectionTransform` to bounding boxes
**Rationale:** Preserves existing single-wall behavior, clean separation of concerns.
**Status:** Pending approval
**Risk:** Medium - requires careful coordinate math

### 4. Schema Versioning Strategy
**Description:** FRD proposes v1.1 for room support.
**Current Constraint:** Schema validates `major_version == 1` only.
**Implementation:** Minor version bump is already supported by pattern `r"^\d+\.\d+$"`.
**Status:** Ready to implement
**Risk:** Low - existing version validation is flexible

---

## Integration Points

### 1. Configuration Loading Path
```
JSON File -> load_config() -> CabinetConfiguration (with room)
          -> config_to_room() [NEW] -> Room entity
          -> config_to_section_specs() [EXTENDED] -> SectionSpec with wall refs
```

### 2. Cabinet Generation Path
```
Room + SectionSpecs -> RoomLayoutService [NEW]
                    -> WallSectionAssignment
                    -> For each wall: LayoutCalculator.generate_cabinet()
                    -> SectionTransform computation
```

### 3. STL Export Path
```
Cabinet(s) + SectionTransforms -> RoomPanel3DMapper [NEW]
                               -> Transformed BoundingBox3D
                               -> StlMeshBuilder.combine_meshes()
```

### 4. Backward Compatibility Path
```
Config without 'room' -> Create implicit single-wall Room
                      -> Existing flow continues unchanged
```

---

## Complexity Assessment

| Component | Complexity | Effort | Risk |
|-----------|------------|--------|------|
| Point2D, WallPosition, GeometryError VOs | Low | 0.5 day | Low |
| WallSegment entity | Low | 0.5 day | Low |
| Room aggregate with position calc | Medium | 1 day | Medium (math) |
| Geometry validation (intersection) | Medium-High | 1 day | Medium (edge cases) |
| RoomLayoutService | Medium | 1 day | Medium |
| Config schema v1.1 extension | Low | 0.5 day | Low |
| Config adapter extension | Low | 0.5 day | Low |
| RoomPanel3DMapper / STL transforms | Medium | 1 day | Medium (3D math) |
| Backward compatibility shim | Low | 0.5 day | Low |
| Tests | Medium | 1.5 days | Low |
| **Total** | | **8-9 days** | |

---

## Next Steps
1. Update FRD with implementation pathways and codebase alignment
2. Mark FRD as "Codebase Aligned and Ready for Task Breakdown"

---

## Open Questions for User/Team Lead

1. **Mesh Transform Approach:** Confirm recommendation (c) - create `RoomPanel3DMapper` wrapper rather than modifying existing `Panel3DMapper`.

2. **Point2D vs Position:** Confirm using both `Point2D` (room coordinates) and `Position` (cabinet-internal) is acceptable for clarity.

3. **Backward Compatibility Testing:** Should we require integration tests for v1.0 configs running through v1.1 codebase?
